
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get user's role
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/counselors/$(userId)).data.role;
    }

    // Helper function to get user's name
    function getUserName(userId) {
      return get(/databases/$(database)/documents/counselors/$(userId)).data.name;
    }

    // Rules for the counselors collection
    match /counselors/{userId} {
      // Admins can manage counselor roles
      allow read, write: if getUserRole(request.auth.uid) == 'admin';
      // A counselor can read their own profile
      allow get: if request.auth.uid == userId;
    }

    // Rules for the students collection
    match /students/{studentId} {
      // Anyone can create a student record (e.g., from the contact form)
      allow create: if request.auth == null || request.auth.uid != null;

      // Admins can read/write any single student document
      allow get, update, delete: if getUserRole(request.auth.uid) == 'admin';
      
      // Counselors can read/write a single student document IF it's assigned to them
      allow get, update: if getUserName(request.auth.uid) == resource.data.assignedTo;

      // --- THIS IS THE CRITICAL FIX FOR THE QUERY ---
      // Define who can LIST (query) documents
      allow list: if 
        // Admins can list all students
        getUserRole(request.auth.uid) == 'admin' ||
        // Counselors can list students IF the query's "where" clause is filtering by their own name
        (getUserRole(request.auth.uid) == 'counselor' && request.query.where.assignedTo == getUserName(request.auth.uid));
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
