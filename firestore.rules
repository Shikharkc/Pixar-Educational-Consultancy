
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get user's role and name from the 'counselors' collection
    function getUserData(userId) {
      return get(/databases/$(database)/documents/counselors/$(userId)).data;
    }

    // Allow authenticated users to read their own counselor profile
    match /counselors/{uid} {
      allow read: if request.auth.uid == uid;
    }

    // Student data rules
    match /students/{studentId} {
      // ADMIN ACCESS: Admins can perform any action on any student document.
      allow read, write: if getUserData(request.auth.uid).role == 'admin';

      // COUNSELOR READ: Allow a counselor to read a single student document if it's assigned to them.
      allow get: if getUserData(request.auth.uid).role == 'counselor'
                  && resource.data.assignedTo == getUserData(request.auth.uid).name;
                  
      // COUNSELOR UPDATE: Allow a counselor to update a single student document if it's assigned to them.
      allow update: if getUserData(request.auth.uid).role == 'counselor'
                  && resource.data.assignedTo == getUserData(request.auth.uid).name;

      // COUNSELOR LIST/QUERY: Allow counselors to query the students collection ONLY IF
      // the query is explicitly filtering for their own name. This is the key fix.
      allow list: if getUserData(request.auth.uid).role == 'counselor'
                  && request.query.where.assignedTo == getUserData(request.auth.uid).name;
    }
  }
}
